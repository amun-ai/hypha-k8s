# version: v3.4.0

# context defines the context of this Desired State File.
# It is used to allow Helmsman identify which releases are managed by which DSF.
# Therefore, it is important that each DSF uses a unique context.

# metadata -- add as many key/value pairs as you want
metadata:
  maintainer: "imjoy-team(imjoy.team@gmail.com)"
  description: "Desired State File for ImJoy App Engine K8s deploy"

namespaces:
  hypha:
  hypha-dev:
  cert-manager:
  nvidia-gpu-operator:
  ingress-nginx:

helmRepos:
  jetstack: "https://charts.jetstack.io"
  nginx-stable: "https://helm.nginx.com/stable"
  ingress-nginx: "https://kubernetes.github.io/ingress-nginx"
  # trow: "https://trow.io"
  # triton-hypha: "file://./triton"
  # hypha: "/home/ctr26/gdrive/+projects/2021_hypha/hypha-helm-charts/charts/hypha"
  hypha: "https://amun-ai.github.io/hypha-helm-charts/"
  nvdp: "https://nvidia.github.io/k8s-device-plugin"
  nvidia: "https://nvidia.github.io/gpu-operator"
  minio: "https://charts.min.io/"
  kuberay: "https://ray-project.github.io/kuberay-helm/"
  # imjoy: https://github.com/imjoy-team/imjoy-app-engine/charts

settings:

appsTemplates:
  hypha: &hypha
    name: "hypha"
    chart: "hypha/hypha"
    enabled: true
    version: "0.16.9"
    wait: false
    timeout: 600
    # namespace: "hypha"
    # Set secrets here
    set:
      jwt_secret: $$JWT_SECRET
      # s3_access_key: $$MINIO_ROOTUSER
      # s3_secret_key: $$MINIO_ROOTPASSWORD
      # minio.rootUser: $$MINIO_ROOTUSER
      # minio.rootPassword: $$MINIO_ROOTPASSWORD
    valuesFiles:
    - helmsman/hypha.yaml
    postInstall: mc/cron.yaml

apps:
  hypha-prod:
    !!merge <<: *hypha
    name: "hypha"
    group: "prod"
    enabled: true
    namespace: "hypha"
    valuesFiles:
    - helmsman/hypha.yaml

  hypha-dev:
    !!merge <<: *hypha
    name: "hypha"
    enabled: false
    priority: -100
    group: "dev"
    namespace: "hypha-dev"
    valuesFiles:
    - helmsman/hypha.yaml
    - helmsman/dev.hypha.yaml

  # triton-hypha:
  #   name: "triton-hypha"
  #   chart: "./triton-hypha"
  #   enabled: true
  #   version: "0.1.0"
  #   wait: true
  #   group: "production"
  #   namespace: "hypha"

  cert-manager:
    name: "cert-manager"
    chart: "jetstack/cert-manager"
    enabled: true
    priority: -10
    # timeout: 120
    version: "v1.11.2"
    wait: true
    group: "prod"
    namespace: "cert-manager"
    set:
      installCRDs: true
      ingressShim.defaultIssuerKind: "ClusterIssuer"
      ingressShim.defaultIssuerName: "letsencrypt"
      # config.leaderElectionConfig.namespace: "cert-manager"
      global.leaderElection.namespace: "cert-manager"
    hooks:
      postUpgrade: "helmsman/cluster_issuer.yaml"
      postInstall: "helmsman/cluster_issuer.yaml"

  # docker-registry:
  #   name: "docker-registry"
  #   namespace: "docker-registry"
  #   chart: "twuni/docker-registry"
  #   group: "production"
  #   enabled: true
  #   version: "1.11.0"
  #   set:
  #     proxy:enabled: true
  #     proxy.username: "$CI_REGISTRY_USER"
  #     proxy.password: "$CI_REGISTRY_PASSWORD"
  #   valuesFiles:
  #     - docker-registry/values.yaml

  nvidia-device-plugin:
    name: "nvidia-device-plugin"
    namespace: "nvidia-gpu-operator"
    chart: "nvdp/nvidia-device-plugin"
    enabled: false
    version: "0.10.0"
    group: "prod"

  nvidia-gpu-operator:
    name: "nvidia-gpu-operator"
    namespace: "nvidia-gpu-operator"
    chart: "nvidia/gpu-operator"
    enabled: false
    version: "v1.10.1"
    group: "prod"

  ingress-nginx:
    name: "ingress-nginx"
    namespace: "ingress-nginx"
    chart: "ingress-nginx/ingress-nginx"
    group: "prod"
    priority: -10
    enabled: true
    version: "4.8.0"
    valuesFiles:
    - helmsman/ingress-nginx.yaml

  # minio:
  #   name: "minio"
  #   namespace: "minio"
  #   chart: "minio/minio"
  #   group: "production"
  #   # wait: true
  #   enabled: false
  #   timeout: 4800
  #   version: "3.3.0"
  #   valuesFiles:
  #       - minio/values.yaml
  #   set:
  #     rootUser: rootuser
  #     rootPassword: rootpass123

  kuberay-operator:
    name: "kuberay-operator"
    namespace: "hypha"
    chart: "kuberay/kuberay-operator"
    enabled: true
    version: "0.5.0"
    group: "prod"

  kuberay-apiserver:
    name: "kuberay-apiserver"
    namespace: "hypha"
    chart: "kuberay/kuberay-apiserver"
    enabled: true
    version: "0.5.0"
    group: "prod"
